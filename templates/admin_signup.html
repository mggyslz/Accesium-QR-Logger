<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='/assets/favicon.ico') }}"/>
    {{ inject_csrf_meta_tag()|safe }}
    <title>Accesium</title>
    <link rel="stylesheet" href="/static/css/global.css" />
  </head>
  <body class="auth-page">
    <div class="signup-box">
      <h2>Admin Signup</h2>
      {% if admin_exists %}
      <p class="subtitle">Create additional admin account</p>
      {% else %}
      <p class="subtitle">Create your first admin account</p>
      {% endif %} 
      
      {% if not smtp_configured %}
      <div class="smtp-warning">
        ⚠️ Email service not configured. 2FA will be disabled. Configure SMTP
        settings in your environment variables.
      </div>
      {% endif %} 
      
      {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %} 
      {% for category, message in messages %}
      <div class="flash {{ category }}">{{ message }}</div>
      {% endfor %} 
      {% endif %} 
      {% endwith %}

      <form method="POST" action="/signup">
        {{ inject_csrf_input()|safe }}

        <div class="form-group">
          <label for="name">Full Name *</label>
          <input
            type="text"
            id="name"
            name="name"
            placeholder="Enter your full name"
            required
            minlength="3"
            maxlength="100"
          />
          <ul class="password-requirements">
            <li>Your display name on the dashboard</li>
          </ul>
        </div>

        <div class="form-group">
          <label for="username">Username *</label>
          <input
            type="text"
            id="username"
            name="username"
            placeholder="Enter username"
            required
            minlength="3"
          />
        </div>

        <div class="form-group">
          <label for="email">Email Address *</label>
          <input
            type="email"
            id="email"
            name="email"
            placeholder="Enter email address"
            required
          />
          <ul class="password-requirements">
            <li>Used for 2FA verification</li>
            <li>Must be valid email format</li>
          </ul>
        </div>

        <div class="form-group">
          <label for="password">Password *</label>
          <div class="password-input-wrapper">
            <input
              type="password"
              id="password"
              name="password"
              placeholder="Enter password"
              required
              minlength="8"
              oninput="validateSignupPassword()"
              style="padding-right: 45px;"
            />
            <span class="password-toggle" onclick="togglePasswordVisibility('password', this)">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"/>
                <line x1="1" y1="1" x2="23" y2="23"/>
              </svg>
            </span>
          </div>
          <div class="password-strength" id="passwordStrength" style="display: none;">
            <div class="strength-bar">
              <div class="strength-fill" id="strengthFill"></div>
            </div>
            <div class="strength-text" id="strengthText">Password strength</div>
          </div>
          <ul class="password-requirements">
            <li>Minimum 8 characters</li>
            <li>Use a strong, unique password, including letters, numbers, and special characters</li>
          </ul>
        </div>

        <div class="form-group">
          <label for="confirm_password">Confirm Password *</label>
          <div class="password-input-wrapper">
            <input
              type="password"
              id="confirm_password"
              name="confirm_password"
              placeholder="Re-enter password"
              required
              oninput="validateSignupPasswordMatch()"
              style="padding-right: 45px;"
            />
            <span class="password-toggle" onclick="togglePasswordVisibility('confirm_password', this)">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"/>
                <line x1="1" y1="1" x2="23" y2="23"/>
              </svg>
            </span>
          </div>
          <div class="match-indicator" id="matchIndicator" style="display: none;">
            <span class="match-icon" id="matchIcon">—</span>
            <span class="match-text" id="matchText">Passwords must match</span>
          </div>
        </div>

        <button type="submit">Create Admin Account</button>
      </form>

      <div class="link-box">
        Already have an account? <a href="/">Login here</a>
      </div>
    </div>

    <script>
      function togglePasswordVisibility(inputId, toggleBtn) {
        const input = document.getElementById(inputId);
        const svg = toggleBtn.querySelector('svg');
        
        if (input.type === 'password') {
          input.type = 'text';
          svg.innerHTML = '<path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/>';
        } else {
          input.type = 'password';
          svg.innerHTML = '<path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"/><line x1="1" y1="1" x2="23" y2="23"/>';
        }
      }

      function validateSignupPassword() {
        const password = document.getElementById('password').value;
        const strengthContainer = document.getElementById('passwordStrength');
        const strengthFill = document.getElementById('strengthFill');
        const strengthText = document.getElementById('strengthText');
        
        if (!password) {
          strengthContainer.style.display = 'none';
          return;
        }
        
        strengthContainer.style.display = 'block';
        
        let strength = 0;
        if (password.length >= 6) strength++;
        if (password.length >= 10) strength++;
        if (/[a-z]/.test(password) && /[A-Z]/.test(password)) strength++;
        if (/\d/.test(password)) strength++;
        if (/[^a-zA-Z0-9]/.test(password)) strength++;
        
        const colors = ['#ff4444', '#ff8800', '#ffaa00', '#88cc00', '#00cc44'];
        const texts = ['Very Weak', 'Weak', 'Fair', 'Good', 'Strong'];
        const widths = ['20%', '40%', '60%', '80%', '100%'];
        
        strengthFill.style.width = widths[strength];
        strengthFill.style.background = colors[strength];
        strengthText.textContent = texts[strength];
        strengthText.style.color = colors[strength];
        
        validateSignupPasswordMatch();
      }
      
      function validateSignupPasswordMatch() {
        const password = document.getElementById('password').value;
        const confirmPassword = document.getElementById('confirm_password').value;
        const matchIndicator = document.getElementById('matchIndicator');
        const matchIcon = document.getElementById('matchIcon');
        const matchText = document.getElementById('matchText');
        
        if (!confirmPassword) {
          matchIndicator.style.display = 'none';
          return;
        }
        
        matchIndicator.style.display = 'flex';
        
        if (password === confirmPassword) {
          matchIcon.textContent = '✓';
          matchIcon.style.color = '#00cc44';
          matchText.textContent = 'Passwords match';
          matchText.style.color = '#00cc44';
        } else {
          matchIcon.textContent = '✗';
          matchIcon.style.color = '#ff4444';
          matchText.textContent = 'Passwords do not match';
          matchText.style.color = '#ff4444';
        }
      }

      document.querySelector("form").addEventListener("submit", function (e) {
        const password = document.getElementById("password").value;
        const confirmPassword = document.getElementById("confirm_password").value;
        const email = document.getElementById("email").value;
        const name = document.getElementById("name").value;

        if (!name || name.trim().length < 3) {
          e.preventDefault();
          alert("Full name must be at least 3 characters!");
          return;
        }

        if (password !== confirmPassword) {
          e.preventDefault();
          alert("Passwords do not match!");
          return;
        }

        if (!email.includes("@") || !email.includes(".")) {
          e.preventDefault();
          alert("Please enter a valid email address!");
          return;
        }
      });
    </script>
  </body>
</html>